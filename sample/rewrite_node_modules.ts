import { readdirSync, renameSync } from "fs";
import { join } from "path";

function rewriteDirectoryName(dirPath: string, oldName: string, newName: string) {
  const allDirs = getAllDirsRecursively(dirPath, oldName);
  allDirs
    .sort()
    .reverse()
    .forEach((dir) => {
      const newDir = join(dir, "..", newName);
      console.log(`Renaming ${dir} -> ${newDir}`);
      renameSync(dir, newDir);
    });
}

// returns absolute paths to directories matching some name
function getAllDirsRecursively(path: string, name: string): string[] {
  const allObjects = readdirSync(path, { withFileTypes: true });
  const allDirs = allObjects.filter((dirent) => dirent.isDirectory());

  const allDirsMatching = allDirs.filter((dirent) => dirent.name === name);
  const allPaths = allDirsMatching.map((dirent) => join(dirent.path, dirent.name));

  return [...allPaths].concat(allDirs.flatMap((dirent) => getAllDirsRecursively(join(dirent.path, dirent.name), name)));
}

rewriteDirectoryName(process.cwd(), "node_modules", "n_m");
